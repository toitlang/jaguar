name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types: [published]

jobs:
  build_jag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.16
      - name: Build jag
        run: |
          GOOS=linux JAG_BINARY=jag_linux make jag
          GOOS=darwin JAG_BINARY=jag_macos make jag
          GOOS=windows JAG_BINARY=jag_windows.exe make jag
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: jag-build
          path: build/jag_*
      - name: Upload jag linux
        if: github.event_name == 'release'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/jag_linux
          tag: ${{ github.ref }}
          asset_name: jag_linux
          overwrite: true

  sign_jag_windows:
    runs-on: windows-signing
    needs: [build_jag]
    # if: github.event_name == 'release'
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: jag-build
      - name: Sign jag
        run: |
          rm -f jag.exe
          mv jag_windows.exe jag.exe
          signtool sign /debug /n "Toitware ApS" /t http://timestamp.digicert.com/ $PWD/jag.exe
          powershell Compress-Archive -Force jag.exe jag.zip
      - name: Build installer
        env:
          INNO: C:\Program Files (x86)\Inno Setup 6\ISCC.exe
        run: |
          echo $INNO
          $INNO /Qp /dMyAppVersion=${{ github.ref }} /dMyAppExeName=$PWD/jag.exe $PWD/tools/windows_installer/installer.iss
          mv $PWD/tools/windows_installer/jag_installer.exe $PWD/jag_installer.exe
          signtool sign /debug /n "Toitware ApS" /t http://timestamp.digicert.com/ $PWD/jag_installer.exe
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: jag-signed-windows
          path: jag.exe
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: jag-signed-windows-installer
          path: jag_installer.exe
      - name: Upload jag Windows (exe)
        if: github.event_name == 'release'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: jag.exe
          tag: ${{ github.ref }}
          asset_name: jag_windows.exe
          overwrite: true
      - name: Upload jag Windows (zip)
        if: github.event_name == 'release'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: jag_windows.zip
          tag: ${{ github.ref }}
          asset_name: jag_windows.zip
          overwrite: true
      - name: Upload jag Windows installer
        if: github.event_name == 'release'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: jag_installer.exe
          tag: ${{ github.ref }}
          asset_name: jag_installer.exe
          overwrite: true

  sign_jag_macos:
    runs-on: macos-latest
    needs: [build_jag]
    if: github.event_name == 'release'
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: jag-build
      - name: import signing keychain
        uses: apple-actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.MACOS_CERTIFICATE }}
          p12-password: ${{ secrets.MACOS_CERTIFICATE_PWD }}
      - name: Sign jag on macOS
        run: |
          /usr/bin/codesign --force -s "Developer ID Application: Toitware ApS (33DS2ZRDST)" ./jag_macos -v
      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: jag-signed-macos
          path: jag_macos
      - name: Upload jag macOS
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: jag_macos
          tag: ${{ github.ref }}
          asset_name: jag_macos
          overwrite: true

  build_toit_images:
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install ninja-build cmake
          ninja --version
          cmake --version
          gcc --version

      - uses: actions/checkout@v2
        with:
          submodules: "recursive"

      - name: Build artifacts
        run: |
          make install-esp-idf
          . ./third_party/toit/third_party/esp-idf/export.sh
          make image
          tar -czf build/image.tar.gz -C ./build -h image
          cp ./build/image.snapshot ./build/jaguar.snapshot
      - name: Upload image artifacts
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/image.tar.gz
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
      - name: Upload jaguar.snapshot artifact
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/jaguar.snapshot
          tag: ${{ github.ref }}
          overwrite: true

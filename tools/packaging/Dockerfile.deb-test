FROM debian:bookworm

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    build-essential \
    debhelper \
    golang-go \
    ca-certificates \
    git \
    lintian \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY . .

# Verify files are present (and force cache invalidation)
RUN ls -l debian/manpages debian/jag.1

# Build the package
# -us -uc: Do not sign source or changes
# -b: Build binary-only package
RUN dpkg-buildpackage -us -uc -b

# List package content for debugging
RUN dpkg -c ../jaguar_*.deb

# Run Lintian
RUN lintian ../jaguar_*.deb

# Install the package
RUN dpkg -i ../jaguar_*.deb

# Verify installation
RUN jag version || echo "jag version failed, but binary might be installed"
RUN which jag
